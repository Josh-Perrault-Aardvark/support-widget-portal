<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Contact Us</title>
  <style>
    :root { --bg:#f8faf8; --card:#fff; --border:#eaeaea; --text:#111; --muted:#616161; --brand:#155b3d; }
    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; background: var(--bg); color: var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    .wrap { min-height: 100vh; display: grid; place-items: center; padding: 32px; }
    .card { width: 100%; max-width: 960px; background: var(--card); border: 1px solid var(--border);
      border-radius: 16px; padding: 24px; box-shadow: 0 6px 24px rgba(0,0,0,.06); }
    .card h1 { margin: 0 0 8px; font-size: 28px; }
    .muted { color: var(--muted); margin: 0 0 16px; }
    label { display:block; font-weight:600; margin: 14px 0 8px; }
    input, textarea { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 10px; font-size: 16px; }
    textarea { min-height: 280px; line-height: 1.5; } /* <- adjust height here */
    button { margin-top: 16px; padding: 10px 16px; border-radius: 10px; border: 1px solid var(--brand);
      background: var(--brand); color: #fff; font-weight: 600; cursor: pointer; }
    .note { margin-top: 10px; font-size: 14px; color: var(--muted); }
    .ok { color:#0a6b3e; }
    .err { color:#b42318; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Contact Us</h1>
      <p class="muted">Have a question? Please submit your message below and we will respond to you via email as soon as we can!</p>

      <form id="cform" novalidate>
        <!-- Email can be hidden if you always pass it in; keeping visible helps users correct typos -->
        <label for="email">Your email</label>
        <input id="email" name="email" type="email" required placeholder="you@example.com" autocomplete="email" />

        <label for="message">Message</label>
        <textarea id="message" name="message" placeholder="Type your message here…"></textarea>

        <button type="submit">Submit</button>
        <div id="status" class="note"></div>
      </form>
    </div>
  </div>

  <script>
    // ---------- Reuse your email resolver ----------
    function getEmailFromHash() {
      const m = (location.hash || "").match(/[#&]email=([^&]+)/i);
      return m ? decodeURIComponent(m[1]).trim() : "";
    }
    function getEmailFromQuery() {
      const qs = new URLSearchParams(location.search);
      return (qs.get("email") || "").trim();
    }
    function base64urlToJson(b64u) {
      try {
        const pad = "=".repeat((4 - (b64u.length % 4)) % 4);
        const b64 = (b64u + pad).replace(/-/g, "+").replace(/_/g, "/");
        return JSON.parse(decodeURIComponent(escape(atob(b64))));
      } catch (_) { return null; }
    }
    function deepFindEmail(obj) {
      if (!obj || typeof obj !== "object") return "";
      for (const [k,v] of Object.entries(obj)) {
        if (typeof v === "string" && v.includes("@")) return v;
        if (v && typeof v === "object") { const nested = deepFindEmail(v); if (nested) return nested; }
      }
      return "";
    }
    function getEmailFromToken() {
      const qs = new URLSearchParams(location.search);
      const token = (qs.get("token") || "").trim();
      if (!token || !token.includes(".")) return "";
      const parts = token.split(".");
      if (parts.length < 2) return "";
      const payload = base64urlToJson(parts[1]);
      return payload ? deepFindEmail(payload) : "";
    }
    const resolvedEmail = getEmailFromHash() || getEmailFromQuery() || getEmailFromToken() || "";
    if (resolvedEmail) document.getElementById('email').value = resolvedEmail;

    // ---------- HubSpot Submission API ----------
    const portalId = "45880416";
    const formGuid  = "e6aec654-2411-411d-9124-4dc25a5ab8d6"; // same HubSpot form

    // If you hit CORS issues, change this to your proxy endpoint (see snippet below)
    const SUBMIT_URL = `https://api.hsforms.com/submissions/v3/integration/submit/${portalId}/${formGuid}`;

    const statusEl = document.getElementById('status');
    function setStatus(msg, ok) {
      statusEl.textContent = msg;
      statusEl.className = "note " + (ok ? "ok" : "err");
    }

    document.getElementById('cform').addEventListener('submit', async (e) => {
      e.preventDefault();

      const email = document.getElementById('email').value.trim();
      const message = document.getElementById('message').value.trim();

      if (!email) { setStatus("Please enter your email.", false); return; }
      // Basic email sanity check
      if (!/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(email)) { setStatus("Please enter a valid email.", false); return; }
      if (!message) { setStatus("Please enter a message.", false); return; }

      setStatus("Sending…", true);

      // HubSpot attribution cookie (optional but nice to include)
      const hutk = document.cookie.split('; ').find(c => c.startsWith('hubspotutk='))?.split('=')[1] || undefined;

      // Build the payload for HubSpot
      const payload = {
        fields: [
          { name: "email", value: email },
          { name: "message", value: message } // <-- if your field has a different internal name, swap it here
        ],
        context: {
          hutk,
          pageUri: location.href,
          pageName: document.title
        }
      };

      try {
        const res = await fetch(SUBMIT_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        if (res.ok) {
          setStatus("Thanks! Your message has been sent.", true);
          e.target.reset();
          // if you want: redirect or show a nicer “thank you”
        } else {
          const txt = await res.text();
          setStatus("Submission failed (" + res.status + "). " + txt, false);
        }
      } catch (err) {
        // Most common issue is CORS blocked by your host setup.
        setStatus("Network error. If this persists, we’ll switch to a tiny proxy (see snippet). " + (err?.message || ""), false);
      }
    });
  </script>
</body>
</html>
