<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Contact Us</title>
  <style>
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; background:#f8faf8; color:#111; }
    .wrap { min-height: 100vh; display:grid; place-items:center; padding:32px; }
    .card { width:100%; max-width:960px; background:#fff; border:1px solid #eaeaea; border-radius:16px; padding:24px; box-shadow:0 6px 24px rgba(0,0,0,.06); }
    h1 { margin:0 0 8px; font-size:28px; }
    .muted { color:#616161; margin:0 0 16px; }
    label { display:block; font-weight:600; margin:14px 0 8px; }
    textarea { width:100%; min-height:280px; line-height:1.5; padding:12px; border:1px solid #e0e0e0; border-radius:10px; font-size:16px; }
    button { margin-top:16px; padding:10px 16px; border-radius:10px; border:1px solid #155b3d; background:#155b3d; color:#fff; font-weight:600; cursor:pointer; }
    button:disabled { opacity:.55; cursor:not-allowed; }
    .note { margin-top:10px; font-size:14px; color:#616161; }
    .ok { color:#0a6b3e; }
    .err { color:#b42318; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Contact Us</h1>
      <p class="muted">Have a question? Please submit your message below and we will respond to you via email as soon as we can!</p>

      <form id="cform" novalidate>
        <!-- Email is truly hidden; we fill it from URL/hash/token -->
        <input id="email" name="email" type="hidden" />

        <label for="message">Your message</label>
        <textarea id="message" name="message" placeholder="Type your message here…" required></textarea>

        <button id="submitBtn" type="submit" disabled>Submit</button>
        <div id="status" class="note"></div>
      </form>
    </div>
  </div>

  <!-- Kill switch: removes any HubSpot embed injected by GTM/CMS -->
  <script>
    (function killHubSpotEmbeds(){
      const nuke = () => {
        document.querySelectorAll('iframe[src*="hsforms"],script[src*="hsforms"]').forEach(el => el.remove());
        document.querySelectorAll('.hs-form, [class*="hs_"], [id*="hs_"]').forEach(el => el.remove());
      };
      nuke();
      const mo = new MutationObserver(nuke);
      mo.observe(document.documentElement, { childList: true, subtree: true });
      setTimeout(() => mo.disconnect(), 8000);
    })();
  </script>

  <script>
    // --- Helpers: resolve email & basic validation ---
    function getEmailFromHash(){ const m=(location.hash||"").match(/[#&]email=([^&]+)/i); return m?decodeURIComponent(m[1]).trim():""; }
    function getEmailFromQuery(){ const qs=new URLSearchParams(location.search); return (qs.get("email")||"").trim(); }
    function base64urlToJson(b64u){ try{ const pad="=".repeat((4-(b64u.length%4))%4); const b64=(b64u+pad).replace(/-/g,"+").replace(/_/g,"/"); return JSON.parse(decodeURIComponent(escape(atob(b64)))); }catch(_){ return null; } }
    function deepFindEmail(obj){ if(!obj||typeof obj!=="object") return ""; for (const v of Object.values(obj)) { if (typeof v==="string" && v.includes("@")) return v; if (v && typeof v==="object"){ const n=deepFindEmail(v); if (n) return n; } } return ""; }
    function getEmailFromToken(){ const qs=new URLSearchParams(location.search); const t=(qs.get("token")||"").trim(); if(!t||!t.includes(".")) return ""; const p=t.split("."); if(p.length<2) return ""; const payload=base64urlToJson(p[1]); return payload?deepFindEmail(payload):""; }
    function isValidEmail(e){ return /^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(e); }

    const emailInput = document.getElementById('email');
    const messageEl  = document.getElementById('message');
    const submitBtn  = document.getElementById('submitBtn');
    const statusEl   = document.getElementById('status');

    // Autofill hidden email (never shown)
    const resolvedEmail = (getEmailFromHash() || getEmailFromQuery() || getEmailFromToken() || "").trim();
    if (resolvedEmail && isValidEmail(resolvedEmail)) {
      emailInput.value = resolvedEmail;
    }

    // Require message content before enabling submit
    function toggleButton() {
      const hasMsg = messageEl.value.trim().length > 0;
      submitBtn.disabled = !hasMsg;
    }
    messageEl.addEventListener('input', toggleButton);
    toggleButton(); // initialize

    function setStatus(msg, ok){ statusEl.textContent = msg; statusEl.className = "note " + (ok ? "ok" : "err"); }

    // --- HubSpot Submission API ---
    const portalId = "45880416";
    const formGuid = "e6aec654-2411-411d-9124-4dc25a5ab8d6";
    const SUBMIT_URL = `https://api.hsforms.com/submissions/v3/integration/submit/${portalId}/${formGuid}`;

    document.getElementById('cform').addEventListener('submit', async (e) => {
      e.preventDefault();

      const email   = emailInput.value.trim();
      const message = messageEl.value.trim();

      // Guard: email must exist & be valid (we never show a field)
      if (!isValidEmail(email)) {
        return setStatus("We couldn't detect your email. Please open this page from your portal link that includes your email.", false);
      }
      if (!message) { // extra safety; button should already be disabled
        return setStatus("Please enter a message.", false);
      }

      setStatus("Sending…", true);

      const hutk = document.cookie.split('; ').find(c => c.startsWith('hubspotutk='))?.split('=')[1];
      const payload = {
        fields: [
          { name: "email", value: email },
          { name: "message", value: message }  // change "message" if your HubSpot internal name differs
        ],
        context: { hutk, pageUri: location.href, pageName: document.title }
      };

      try {
        const res = await fetch(SUBMIT_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        const text = await res.text();
        if (res.ok) {
          setStatus("Thanks! Your message has been sent.", true);
          e.target.reset();
          toggleButton();
        } else {
          setStatus("Submission failed (" + res.status + "). " + text, false);
        }
      } catch (err) {
        setStatus("Network/CORS error. If this persists, we’ll switch to a tiny proxy.", false);
      }
    });
  </script>
</body>
</html>
